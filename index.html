<!doctype html>
<html>
<head>
	<meta charset="utf-8" >
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />

	<title>Food Oasis Los Angeles</title>
	
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Reem+Kufi" />
	<link rel="stylesheet" href="assets/leaflet/leaflet.css" />
	<link rel="stylesheet" href="assets/css/oasis.css" />

	<!-- Need the following files to enable Mapbox -->
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.21.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.21.0/mapbox-gl.css' rel='stylesheet' />
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v1.3.0/mapbox-gl-geocoder.js'></script>
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v1.3.0/mapbox-gl-geocoder.css' type='text/css' />
</head>
<body class="home">
	<div class="header">
		<h1><a href="/about"><img src="assets/images/food-oasis-la-horizontal.svg" width="300" alt="Food Oasis Los Angeles" /></a></h1>
	</div>

	<div id="map" class="mapbox"></div>

	<script src="assets/leaflet/leaflet.js"></script>
	<script>

		mapboxgl.accessToken = 'pk.eyJ1IjoiZm9vZGRlc2VydHNsYSIsImEiOiJjaXByOXRscnMwNzY1Zm5ub3YwYTd5Z3dsIn0.DWgUhgW32pVkybKx7cWWiw';

		var bounds = [
			[-118.9442369,33.7089729], // Southwest coordinates
			[-117.63282912,34.8275538]  // Northeast coordinates
		];

		var map = new mapboxgl.Map({
			container: 'map', // container id
			style: 'mapbox://styles/fooddesertsla/ciqlgjsvb0001bkno0wkx8gg8', // stylesheet location
			center: [-118.243683, 34.052235], // starting position
			zoom: 13, // starting zoom
			maxBounds: bounds
		});
		
		var myLat = 0;
	    var myLon = 0;
	    var myCoords = [];		

		function findMe() {
			navigator.geolocation.getCurrentPosition(success, error);

			function success(position) {
			    // Set new starting location
			    myLat = position.coords.latitude;
			    myLon = position.coords.longitude;
			    myCoords = [myLon, myLat];
				map.panTo(myCoords);

				// Place a current location marker
				while (map.getCenter().toArray() == myCoords) {
					// map.on('load', function () {
					//     map.addSource("points", {
					//         "type": "geojson",
					//         "data": {
					//             "type": "FeatureCollection",
					//             "features": [{
					//                 "type": "Feature",
					//                 "geometry": {
					//                     "type": "Point",
					//                     "coordinates": myCoords
					//                 },
					//                 "properties": {
					//                     "title": "My Location",
					//                     "icon": mymarker
					//                 }
					//             }]
					//         }
					//     });

					//     map.addLayer({
					//         "id": "points",
					//         "type": "symbol",
					//         "source": "points",
					//         "layout": {
					//             "icon-image": "{icon}",
					//             "text-field": "{title}",
					//             "text-font": ["Open Sans Semibold", "Arial Unicode MS Bold"],
					//             //"text-color": "#ffff00",
					//             //"text-opacity": 0.75,
					//             "text-offset": [0, 0.75],
					//             "text-anchor": "top"
					//         }
					//     });
					// });
				};
			};

			function error() {
				alert("Unable to retrieve your location");
			};

			function showPosition(position) {
				//x.innerHTML = "Latitude: " + position.coords.latitude + "<br>Longitude: " + position.coords.longitude; 

			    myLat = position.coords.latitude;
			    myLon = position.coords.longitude;
			};
		};

		// Add Search Functionality
		map.addControl(new mapboxgl.Geocoder());	

		// Add 'Current Location' Functionality
		map.addControl(new mapboxgl.Geolocate());

		// Create a popup, but don't add it to the map yet.
		var popup = new mapboxgl.Popup({
			closeButton: false,
			closeOnClick: false
		});
	
		// Creates a popup on hover
		map.on('click', function(e) {
			var features = map.queryRenderedFeatures(e.point, { layers: ['Food Banks (Solution)','CG-UF-N (Solution)','Farmers Markets (Solution)','Groceries (Problem)'] });

			// Change the cursor style as a UI indicator.
			map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';
			if (!features.length) {
				popup.remove();
				return;
			}

			var feature = features[0];

			// Name
			var name = 	feature.properties["name"] || 
						feature.properties["Name"] ||
						feature.properties["NAME"] ||
						feature.properties["NAME:"] ||
						feature.properties["MarketName"];

			// Hours
			var hours = feature.properties["times"] ||
						feature.properties["Times"] ||
						feature.properties["TIMES"] ||
						feature.properties["TIMES:"];

			// Phone
			var telephone = feature.properties["telephone"] ||
							feature.properties["Telephone"] ||
							feature.properties["CONTACT"] ||
							feature.properties["CONTACT:"];

			// Address
			var address = "";
			var street = 	feature.properties["address"] ||
							feature.properties["Address"] ||
							feature.properties["ADDRESS"] ||
							feature.properties["ADDRESS:"];
			var city = 	feature.properties["city"] ||
						feature.properties["City"];
			var state = feature.properties["state"] ||
						feature.properties["State"];
			if (street) address += street;
			if (city) address += (street ? '<br />' : '') + city;
			if (state) address += (city ? ', ' : (street ? '<br />' : '')) + state;

			// TEMPORARY: Only show links to food banks (since the /source/ pages are only generated for food banks presently).
			var showLink = (feature.layer.id === 'Food Banks (Solution)') ? true : false;

			var html = [];

			html.push('<div class="map-point-details">');

			if (name && showLink) {
				var uri = name.toLowerCase().replace(/\s/g, '-')
											.replace(/\//g, '-')
											.replace(/\&/g, '-')
											.replace(/\./g, '-')
											.replace(/\'/g, '')
											.replace(/\-\-/g, '-')
				html.push('<h3><a href="/source/' + uri + '/">' + name + '</a></h3>');
			} else if (name) {
				html.push('<h3>' + name + '</h3>');
			}
			if (address) {
				html.push('<p>' + address + '</p>');
			}
			if (telephone) {
				html.push('<p>' + telephone + '</p>');
			}
			// html.push("<p>"+feature.properties["CONTACT"]+"</p>");
			if (hours) {
				html.push('<h4>Hours</h4>');
				html.push('<p class="hours">' + hours + '</p>');
			}

			html.push('</div>');

			//console.log(feature);//Displays the contents as an array in the console log

			popup.setLngLat(feature.geometry.coordinates).setHTML(html.join('')).addTo(map);
		}); 

		// Grab user's location on page-load
		if ("geolocation" in navigator) {
			findMe()
		}

	</script>
	
</body>
</html>
